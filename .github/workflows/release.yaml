# "This workflow is disabled by default and must be enabled manually.
name: "Release (Hybrid: GitHub-hosted + Optional Self-hosted)"

on:
  workflow_dispatch:
    inputs:
      run_self_hosted:
        description: "Run device/intranet tests on self-hosted runner (requires an online runner with label: self-hosted, windows, x64, release)"
        type: boolean
        default: false
  push:
    tags:
      - "v*.*.*"

# 같은 runner 에서 작업이 겹치지 않도록 (권장)
concurrency:
  group: windows-release-hybrid
  cancel-in-progress: false

permissions:
  contents: write

env:
  CI: "true"
  PYTHON_MIN: "3.8"
  VENV_DIR: ".venv"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"
  PYTHONDONTWRITEBYTECODE: "1"

jobs:
  notebook_report:
    name: Notebook run (best-effort) + HTML report [GitHub-hosted]
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # GitHub-hosted에서는 setup-python 사용 가능 (self-hosted의 ExecutionPolicy 이슈 없음)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Verify Python (>= PYTHON_MIN)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          python --version
          $cur = [version](python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          $min = [version]"$env:PYTHON_MIN"
          if ($cur -lt $min) { throw "Python >= $env:PYTHON_MIN required. Current: $cur" }

      - name: Create venv
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (Test-Path "$env:VENV_DIR") { Remove-Item -Recurse -Force "$env:VENV_DIR" }
          python -m venv "$env:VENV_DIR"
          & "$env:VENV_DIR\Scripts\python" -c "import sys; print('venv python:', sys.executable)"

      - name: Install dependencies into venv
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          & "$env:VENV_DIR\Scripts\python" -m pip install --upgrade pip setuptools wheel
          if (Test-Path "requirements.txt") {
            & "$env:VENV_DIR\Scripts\python" -m pip install -r requirements.txt
          }
          & "$env:VENV_DIR\Scripts\python" -m pip install jupyter nbconvert nbclient papermill ipykernel
          & "$env:VENV_DIR\Scripts\python" -m ipykernel install --user --name python --display-name "Python (CI)"

      - name: Run notebooks (best-effort) and export HTML
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $outExecDir = "artifacts\executed_notebooks"
          $outHtmlDir = "artifacts\reports_html"
          New-Item -ItemType Directory -Force -Path $outExecDir | Out-Null
          New-Item -ItemType Directory -Force -Path $outHtmlDir | Out-Null

          $py = "$env:VENV_DIR\Scripts\python"

          # 우선순위:
          # 1) 루트의 Project_Spero_cProject_Speroi.ipynb (있으면 이것만 실행)
          # 2) notebooks/ 아래 *.ipynb 전체 실행 (단, *.no-ci.ipynb 는 스킵)
          $preferred = "Project_Spero.ipynb"
          $nbs = @()

          if (Test-Path $preferred) {
            $nbs = @(Get-Item $preferred)
            Write-Host "Using preferred notebook: $preferred"
          } elseif (Test-Path "notebooks") {
            $nbs = Get-ChildItem -Path "notebooks" -Recurse -Filter "*.ipynb" |
                   Where-Object { $_.FullName -notmatch "\.no-ci\.ipynb$" }
            Write-Host "Found notebooks under notebooks/: $($nbs.Count)"
          } else {
            Write-Host "No notebook target found (Project_Spero.ipynb or notebooks/)."
            exit 0
          }

          foreach ($nb in $nbs) {
            $nameOnly = [IO.Path]::GetFileNameWithoutExtension($nb.Name)
            $execOut  = Join-Path $outExecDir ($nameOnly + ".executed.ipynb")

            Write-Host "Running notebook: $($nb.FullName)"
            try {
              & $py -m papermill "$($nb.FullName)" "$execOut" -k python --request-save-on-cell-execute
            }
            catch {
              Write-Warning "Notebook failed (best-effort): $($nb.FullName)"
              Write-Warning $_
              continue
            }

            Write-Host "Exporting HTML: $execOut"
            & $py -m jupyter nbconvert "$execOut" --to html --output-dir "$outHtmlDir" --no-input
          }

      - name: Upload notebook artifacts
        uses: actions/upload-artifact@v4
        with:
          name: notebook-reports
          path: artifacts/
          if-no-files-found: warn

      - name: Publish GitHub Release (attach reports)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/reports_html/*.html
            artifacts/executed_notebooks/*.ipynb

  unit_tests:
    name: Unit tests (non-device) [GitHub-hosted]
    runs-on: windows-latest
    timeout-minutes: 60
    needs: [notebook_report]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Create venv + install deps
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (Test-Path "$env:VENV_DIR") { Remove-Item -Recurse -Force "$env:VENV_DIR" }
          python -m venv "$env:VENV_DIR"
          & "$env:VENV_DIR\Scripts\python" -m pip install --upgrade pip setuptools wheel
          if (Test-Path "requirements.txt") {
            & "$env:VENV_DIR\Scripts\python" -m pip install -r requirements.txt
          }
          & "$env:VENV_DIR\Scripts\python" -m pip install pytest

      - name: Run tests (skip device/intranet markers if they exist)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (Test-Path "tests") {
            # device/intranet 테스트는 self-hosted에서만 수행하도록 제외
            & "$env:VENV_DIR\Scripts\python" -m pytest -q tests -m "not device and not intranet" --maxfail=1
          } else {
            Write-Host "No tests/ directory. Skipping."
          }

      - name: Upload test logs (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-logs
          path: |
            .pytest_cache/
            **/test-results*.xml
            **/*.log
          if-no-files-found: ignore

  device_and_intranet_tests_selfhosted:
    name: Device/Intranet tests [Self-hosted OPTIONAL]
    # self-hosted runner가 없으면 "대기 상태로 멈추지 않도록"
    # workflow_dispatch에서 입력값을 true로 켰을 때만 실행합니다.
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_self_hosted }}
    runs-on: [self-hosted, windows, x64, release]
    timeout-minutes: 60
    needs: [unit_tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Python on runner (>= PYTHON_MIN)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          where.exe python
          python --version
          $cur = [version](python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          $min = [version]"$env:PYTHON_MIN"
          if ($cur -lt $min) { throw "Python >= $env:PYTHON_MIN required. Current: $cur" }

      - name: Create venv + install deps (self-hosted)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          if (Test-Path "$env:VENV_DIR") { Remove-Item -Recurse -Force "$env:VENV_DIR" }
          python -m venv "$env:VENV_DIR"
          & "$env:VENV_DIR\Scripts\python" -m pip install --upgrade pip setuptools wheel
          if (Test-Path "requirements.txt") {
            & "$env:VENV_DIR\Scripts\python" -m pip install -r requirements.txt
          }
          & "$env:VENV_DIR\Scripts\python" -m pip install pytest

      - name: Run device/intranet tests (self-hosted)
        shell: powershell
        env:
          DEVICE_TEST: "1"
          INTRANET_TEST: "1"
        run: |
          $ErrorActionPreference = "Stop"
          if (Test-Path "tests") {
            & "$env:VENV_DIR\Scripts\python" -m pytest -q tests -m "device or intranet" --maxfail=1
          } else {
            Write-Host "No tests/ directory. Skipping device/intranet tests."
          }

      - name: Upload self-hosted test logs (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: device-intranet-test-logs
          path: |
            .pytest_cache/
            **/test-results*.xml
            **/*.log
          if-no-files-found: ignore

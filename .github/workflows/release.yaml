name: Release (Windows Self-Hosted)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

# 같은 runner 에서 장비 테스트가 겹치지 않도록 (권장)
concurrency:
  group: windows-selfhosted-release
  cancel-in-progress: false

permissions:
  contents: write

# ✅ self-hosted runner PC에 Python이 이미 설치되어 있다는 가정.
# ✅ GitHub-hosted 액션의 PowerShell 스크립트 실행(ExecutionPolicy) 이슈를 피하기 위해
#    run step은 기본적으로 cmd로 실행합니다.
defaults:
  run:
    shell: cmd

env:
  CI: "true"
  PYTHON_MIN: "3.8"
  VENV_DIR: ".venv"
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"

jobs:
  notebook_report:
    name: Notebook run (best-effort) + HTML report
    runs-on: [self-hosted, windows, x64, release]
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Python (preinstalled on runner, >= PYTHON_MIN)
        run: |
          where.exe python
          python --version
          python -c "import os,sys; minv=os.environ.get('PYTHON_MIN','3.8'); mv=tuple(map(int,minv.split('.')[:2])); cur=(sys.version_info.major,sys.version_info.minor); print(f'Python OK: {sys.version.split()[0]} (required >= {minv})'); sys.exit(0 if cur>=mv else 1)"

      - name: Create venv and verify venv is used
        run: |
          if exist "%VENV_DIR%" rmdir /s /q "%VENV_DIR%"
          python -m venv "%VENV_DIR%"
          "%VENV_DIR%\Scripts\python" -c "import sys; print('venv python:', sys.executable); assert '.venv' in sys.executable.lower(), sys.executable"

      - name: Install dependencies into venv
        run: |
          "%VENV_DIR%\Scripts\python" -m pip install --upgrade pip setuptools wheel
          if exist requirements.txt "%VENV_DIR%\Scripts\python" -m pip install -r requirements.txt
          "%VENV_DIR%\Scripts\python" -m pip install jupyter nbconvert nbclient papermill ipykernel
          "%VENV_DIR%\Scripts\python" -m ipykernel install --user --name python --display-name "Python (CI)"

      - name: Run notebooks (best-effort) and export HTML
        run: |
          if not exist artifacts\executed_notebooks mkdir artifacts\executed_notebooks
          if not exist artifacts\reports_html mkdir artifacts\reports_html

          if exist Project_Spero_ci.ipynb (
            echo Using preferred notebook: Project_Spero_ci.ipynb
            "%VENV_DIR%\Scripts\python" -m papermill Project_Spero_ci.ipynb artifacts\executed_notebooks\Project_Spero_ci.executed.ipynb -k python --request-save-on-cell-execute
            "%VENV_DIR%\Scripts\python" -m jupyter nbconvert artifacts\executed_notebooks\Project_Spero_ci.executed.ipynb --to html --output-dir artifacts\reports_html --no-input
          ) else (
            if exist notebooks (
              echo Running notebooks under notebooks\ (skipping *.no-ci.ipynb)
              for /r notebooks %%F in (*.ipynb) do (
                echo %%~nxF | findstr /i "\.no-ci\.ipynb$" >nul
                if errorlevel 1 (
                  echo Running: %%F
                  "%VENV_DIR%\Scripts\python" -m papermill "%%F" "artifacts\executed_notebooks\%%~nF.executed.ipynb" -k python --request-save-on-cell-execute
                  if errorlevel 1 (
                    echo Notebook failed (best-effort): %%F
                  ) else (
                    "%VENV_DIR%\Scripts\python" -m jupyter nbconvert "artifacts\executed_notebooks\%%~nF.executed.ipynb" --to html --output-dir artifacts\reports_html --no-input
                  )
                ) else (
                  echo Skipped: %%F
                )
              )
            ) else (
              echo No notebook target found (Project_Spero_ci.ipynb or notebooks\). Skipping.
            )
          )

      - name: Upload notebook artifacts
        uses: actions/upload-artifact@v4
        with:
          name: notebook-reports
          path: artifacts/
          if-no-files-found: warn

      - name: Publish GitHub Release (attach reports)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/reports_html/*.html
            artifacts/executed_notebooks/*.ipynb

  device_and_intranet_tests:
    name: Device/Intranet dependent tests (Windows self-hosted)
    runs-on: [self-hosted, windows, x64, release]
    timeout-minutes: 60
    needs: [notebook_report]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Python (preinstalled on runner, >= PYTHON_MIN)
        run: |
          where.exe python
          python --version
          python -c "import os,sys; minv=os.environ.get('PYTHON_MIN','3.8'); mv=tuple(map(int,minv.split('.')[:2])); cur=(sys.version_info.major,sys.version_info.minor); print(f'Python OK: {sys.version.split()[0]} (required >= {minv})'); sys.exit(0 if cur>=mv else 1)"

      - name: Create venv and verify venv is used
        run: |
          if exist "%VENV_DIR%" rmdir /s /q "%VENV_DIR%"
          python -m venv "%VENV_DIR%"
          "%VENV_DIR%\Scripts\python" -c "import sys; print('venv python:', sys.executable); assert '.venv' in sys.executable.lower(), sys.executable"

      - name: Install dependencies into venv
        run: |
          "%VENV_DIR%\Scripts\python" -m pip install --upgrade pip setuptools wheel
          if exist requirements.txt "%VENV_DIR%\Scripts\python" -m pip install -r requirements.txt
          "%VENV_DIR%\Scripts\python" -m pip install pytest

      - name: Run device/intranet tests
        env:
          DEVICE_TEST: "1"
          INTRANET_TEST: "1"
        run: |
          if exist tests (
            "%VENV_DIR%\Scripts\python" -m pytest -q tests -m "device or intranet" --maxfail=1
          ) else (
            echo No tests\ directory. Skipping device/intranet tests.
          )

      - name: Upload test logs (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: device-test-logs
          path: |
            .pytest_cache/
            **/test-results*.xml
            **/*.log
          if-no-files-found: ignore

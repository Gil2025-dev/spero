name: Release (Windows Self-Hosted)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

# 같은 runner 에서 장비 테스트가 겸치지 않도록 (권장  )
concurrency:
  group: windows-selfhosted-release
  cancel-in-progress: false

permissions:
  contents: write

env:
  CI: "true"
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"

jobs:
  notebook_report:
    name: Notebook run (best-effort) + HTML report
    runs-on: [self-hosted, windows, x64, release]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install build twine

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
          # Notebook 실행/변환 도구(프로젝트 requirements에 이미 있으면 중복 설치되어도 무해)
          pip install jupyter nbconvert nbclient papermill
      
      - name: Run notebooks (best-effort) and export HTML
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # 노트북 경로 규칙:
          # - 기본: notebooks/ 아래의 *.ipynb 전부
          # - 파일명에 ".no-ci.ipynb" 포함되면 CI에서 스킵
          $nbRoot = "notebooks"
          $outExecDir = "artifacts\executed_notebooks"
          $outHtmlDir = "artifacts\reports_html"
          New-Item -ItemType Directory -Force -Path $outExecDir | Out-Null
          New-Item -ItemType Directory -Force -Path $outHtmlDir | Out-Null

          if (-not (Test-Path $nbRoot)) {
            Write-Host "No notebooks/ directory. Skipping notebook run."
            exit 0
          }

          $nbs = Get-ChildItem -Path $nbRoot -Recurse -Filter "*.ipynb" |
                 Where-Object { $_.FullName -notmatch "\.no-ci\.ipynb$" }

          if ($nbs.Count -eq 0) {
            Write-Host "No notebooks found (or all skipped)."
            exit 0
          }

          foreach ($nb in $nbs) {
            $rel = Resolve-Path $nb.FullName
            $nameOnly = [IO.Path]::GetFileNameWithoutExtension($nb.Name)
            $execOut = Join-Path $outExecDir ($nameOnly + ".executed.ipynb")

            Write-Host "Running notebook: $($nb.FullName)"
            # best-effort: 실패해도 전체 workflow를 멈추고 싶다면 catch 제거.
            try {
              # papermill로 실행된 노트북 저장
              papermill "$($nb.FullName)" "$execOut" -k python --request-save-on-cell-execute
            }
            catch {
              Write-Warning "Notebook failed (best-effort): $($nb.FullName)"
              Write-Warning $_
              continue
            }

            Write-Host "Exporting HTML: $execOut"
            jupyter nbconvert "$execOut" --to html --output-dir "$outHtmlDir" --no-input
          }

      - name: Upload notebook artifacts
        uses: actions/upload-artifact@v4
        with:
          name: notebook-reports
          path: artifacts/
          if-no-files-found: warn
      
      # 태그 푸시일 때만 GitHub Release에 리포트 첨부
      - name: Publish GitHub Release (attach reports)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/reports_html/*.html
            artifacts/executed_notebooks/*.ipynb